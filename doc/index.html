<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />

<!-- CSS only -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
        integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css"
        integrity="sha512-3q8fi8M0VS+X/3n64Ndpp6Bit7oXSiyCnzmlx6IDBLGlY5euFySyJ46RUlqIVs0DPCGOypqP8IRk/EyPvU28mQ==" crossorigin="anonymous"
        referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css"
        integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous" />

  <title>Z Scale Train Controller</title>

  <script type="text/javascript">
    var ws;
  
    window.addEventListener('beforeunload', (event) => {
      ws.close();
      // Cancel the event as stated by the standard.
      event.preventDefault();
      // Older browsers supported custom message
      event.returnValue = '';
    });
  
    function WebSocketBegin() {
      if ("WebSocket" in window) {
        // Let us open a web socket
        ws = new WebSocket("ws://" + window.location.hostname + ":8080/");

        ws.onopen = function () {
          // Web Socket is connected
        };

        ws.onmessage = function (evt) {
          //create a JSON object
          var jsonObject = JSON.parse(evt.data);
        };

        ws.onclose = function (evt) {
          if (evt.wasClean) {
            alert(`[close] Connection closed cleanly, code=${evt.code} reason=${evt.reason}`);
          } else {
            // e.g. server process killed or network down
            // event.code is usually 1006 in this case
            alert('[close] Connection died');
          }
        };

        ws.onerror = function (error) {
          alert(`[error] foo ${error.message}`);
        }


      } else {
        // The browser doesn't support WebSocket
        alert("WebSocket NOT supported by your Browser!");
      }
   }

   var track = [false, false, false];
   var point = [false, false, false];
   var power = 0;

   var system = { track : track
                , point : point
                , power : power };
 

   function click_handler(obj, state) {
     if (obj.name == "track_1") {
       track[0] = state;
       ws.send(JSON.stringify({"track" : [0, track[0]]}));
     } else if (obj.name == "track_2") {
       track[1] = state;
       ws.send(JSON.stringify({"track" : [1, track[1]]}));
     } else if (obj.name == "track_3") {
       track[2] = state;
       ws.send(JSON.stringify({"track" : [2, track[2]]}));
     } else if (obj.name == "switch_1") {
       point[0] = state;
       ws.send(JSON.stringify({"point" : [0, point[0]]}));
     } else if (obj.name == "switch_2") {
       point[1] = state;
       ws.send(JSON.stringify({"point" : [1, point[1]]}));
     } else if (obj.name == "switch_3") {
       point[2] = state;
       ws.send(JSON.stringify({"point" : [2, point[2]]}));
     } else {
       alert(`Unknown Object`);
     }
   }
  </script>
</head>

<body onLoad="javascript:WebSocketBegin()">
  <header id="main-header" class="py-2 bg-success text-white">
    <div class="container">
      <div class="row justify-content-md-center">
        <div class="col-md-6 text-center">
          <h1><i class="fas fa-cog"></i> Z Scale Train Controller</h1>
        </div>
      </div>
    </div>
  </header>

  <section class="py-5 bg-white">
    <div class="container">
          <div class="card bg-light m-2 h-100" style="min-height: 10rem;">
            <div class="card-header">Master Power</div>
            <div class="card-body">
              <input id="master_power" type="text"/>
            </div>
            </div>
          </div>
    </div>
 
    <p></p>

    <div class="container">
          <div class="card bg-light m-2 h-100" style="min-height: 15rem;">
            <div class="card-header">Track Power</div>
            <div class="card-body">
                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                  <label class="btn btn-secondary active">
                    <input type="radio" name="track_1" id="track_1_off" autocomplete="off" onclick="click_handler(this, false)" checked> Off
                  </label>
                  <label class="btn btn-secondary">
                    <input type="radio" name="track_1" id="track_1_on" autocomplete="off" onclick="click_handler(this, true)"> On
                  </label>
                </div>
                Track 1
                <p></p>
                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                  <label class="btn btn-secondary active">
                    <input type="radio" name="track_2" id="track_2_off" autocomplete="off" onclick="click_handler(this, false)" checked> Off
                  </label>
                  <label class="btn btn-secondary">
                    <input type="radio" name="track_2" id="track_2_on" autocomplete="off" onclick="click_handler(this, true)"> On
                  </label>
                </div>
                Track 2
                <p></p>
                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                  <label class="btn btn-secondary active">
                    <input type="radio" name="track_3" id="track_3_off" autocomplete="off" onclick="click_handler(this, false)" checked> Off
                  </label>
                  <label class="btn btn-secondary">
                    <input type="radio" name="track_3" id="track_3_on" autocomplete="off" onclick="click_handler(this, true)"> On
                  </label>
                </div>
                Track 3
            </div>
            </div>
      </div>
    </div>

    <p></p>

    <div class="container">
          <div class="card bg-light m-2 h-100" style="min-height: 15rem;">
            <div class="card-header">Switch State</div>
            <div class="card-body">
                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                  <label class="btn btn-secondary active">
                    <input type="radio" name="switch_1" id="switch_1_off" autocomplete="off" onclick="click_handler(this, false)" checked> Straight
                  </label>
                  <label class="btn btn-secondary">
                    <input type="radio" name="switch_1" id="switch1_on" autocomplete="off" onclick="click_handler(this, true)"> Bypass
                  </label>
                </div>
                Switch 1
                <p></p>
                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                  <label class="btn btn-secondary active">
                    <input type="radio" name="switch_2" id="switch_2_off" autocomplete="off" onclick="click_handler(this, false)" checked> Straight
                  </label>
                  <label class="btn btn-secondary">
                    <input type="radio" name="switch_2" id="switch_2_on" autocomplete="off" onclick="click_handler(this, true)"> Bypass
                  </label>
                </div>
                Switch 2
                <p></p>
                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                  <label class="btn btn-secondary active">
                    <input type="radio" name="switch_3" id="switch_3_off" autocomplete="off" onclick="click_handler(this, false)" checked> Straight
                  </label>
                  <label class="btn btn-secondary">
                    <input type="radio" name="switch_3" id="switch_3_on" autocomplete="off" onclick="click_handler(this, true)"> Bypass
                  </label>
                </div>
                Switch 3
            </div>
            </div>
          </div>
    </div>

  </section>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js"
            integrity="sha512-f0VlzJbcEB6KiW8ZVtL+5HWPDyW1+nJEjguZ5IVnSQkvZbwBt2RfCBY0CBO1PsMAqxxrG4Di6TfsCPP3ZRwKpA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      var slider = new Slider("#master_power", {
                   tooltip: 'always',
                   tooltip_position: 'bottom', 
                   min: -100,
                   max: 100,
                   step: 5,
                   value: 0,
                   });
 
      slider.on("slide", function(sliderValue) { if (power != sliderValue) {power = sliderValue; ws.send(JSON.stringify({"power" : power}));} });
    </script>
</body>

</html>
